<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Profile</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
      <link rel="icon" href="../static/images/favicon.png" type="image/png">

  <style>
    body {
      background-color: #f0f2f5;
      font-family: 'Segoe UI', sans-serif;
    }
    .card-title .btn {
  font-size: 0.85rem;
  padding: 0.25rem 0.5rem;
}
  .topic-chip {
    border-radius: 999px;
  }
.section-header {
  background-color: #e9ecef; /* Calm gray background */
  color: #212529;
  padding: 50px 0;
  text-align: center;
  border-bottom: 1px solid #dee2e6;
}
.section-header .avatar {
  width: 100px;
  height: 100px;
  background: #ced4da;
  border-radius: 50%;
  font-size: 36px;
  font-weight: 700;
  color: #495057;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: auto;
}

    .main-content {
      margin-top: -40px;
      padding-bottom: 60px;
    }
    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      padding: 30px;
    }
    .card-title {
      font-weight: 700;
      font-size: 1.3rem;
      margin-bottom: 1.2rem;
      color: #333;
    }
    .chart-container {
      margin-bottom: 30px;
    }
    canvas {
      max-height: 300px;
    }
    .score-table th, .score-table td {
      text-align: center;
      vertical-align: middle;
    }
    .score-table tr:hover {
      background-color: #f9f9f9;
    }
  </style>
</head>
<body>
{% include 'nav.html' %}

<section class="section-header">
  <div class="container">
    <div class="avatar mb-3">{{ username[0]|upper }}</div>
    <h2 class="fw-bold">{{ username }}</h2>
    <p class="opacity-75 mb-0">Your personalized political debate summary</p>
  </div>
</section>

<div class="container main-content">
  <!-- ROW 1: PoliticMBTI + Debate History -->
  <div class="row g-4 mb-4">
    <!-- PoliticMBTI -->
    <div class="col-lg-4">
      <div class="glass-card h-100">
        <div class="card-title d-flex align-items-center justify-content-between">
  <span>PoliticMBTI Result</span>
  <button type="button"
          class="btn btn-sm btn-outline-secondary"
          data-bs-toggle="popover"
          data-bs-placement="left"
          title="What is PoliticalMBTI?"
          data-bs-content="Your PoliticalMBTI is a 4-letter type (e.g., EPGR) based on 80 survey questions across 4 axes:
Economy vs. Freedom, Progress vs. Culture, Globalism vs. Nationalism, and Regulation vs. Individualism. It suggests your political tendencies, career alignment, and international compatibility.">
    <i class="bi bi-info-circle"></i>
  </button>
</div>

        {% if politicmbti %}
        <p><strong>{{ politicmbti.code }}</strong> – {{ politicmbti.nickname }}</p>
        <p><strong>Description:</strong> {{ politicmbti.description}}</p>
        <p><strong>Careers:</strong> {{ politicmbti.careers | join(', ') }}</p>
        <p><strong>Countries:</strong> {{ politicmbti.countries | join(', ') }}</p>

        <div class="alert alert-primary small mt-3 mb-0">
          Characteristic: {{ politicmbti.caution }}
        </div>

        {% else %}
        <p class="text-muted">No PoliticMBTI result available.</p>
        {% endif %}
      </div>
    </div>

    <!-- Debate History -->
    <div class="col-lg-8">
      <div class="glass-card h-100">
        <div class="card-title">Debate History</div>
        {% for topic, data in debate_details.items() %}
        <div class="d-flex justify-content-between align-items-center p-3 mb-2 bg-light rounded-3 shadow-sm">
          <div>
            <strong><a href="{{ url_for('view_debate', debate_id=data.debate_id) }}" style="color:black; text-decoration:none;"> {{ topic }}</a></strong><br>
            <small class="text-muted">{{ data.date }}</small>
          </div>
          <a href="{{ url_for('view_debate', debate_id=data.debate_id) }}" class="text-decoration-none text-primary">
            <i class="bi bi-chevron-right"></i>
          </a>
        </div>
        {% endfor %}
        {% if not debate_details %}
        <p class="text-muted">You haven't participated in any debates yet.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- ROW 2: Political Alignment Overview -->
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="glass-card text-center">
        <div class="card-title">Summary of your Political Alignment</div>
 <h6 class="fw-semibold mb-3" style="font-size: 1.1rem; color: #495057;">Political Alignment Overview</h6>
        <div class="chart-container">
          <canvas id="radarChartProfile"></canvas>
        </div>


                      <h6 class="fw-semibold mb-3 mt-5" style="font-size: 1.1rem; color: #495057;">Political Score Divergence per Category</h6>

<div class="d-flex flex-column gap-2 mb-2">
  <div id="debatePickerWrap" class="d-flex align-items-center gap-2"></div>

  <div class="d-flex align-items-center gap-2 flex-wrap">
    <strong class="me-1">Topics:</strong>
    <div id="topicToggleControls" class="btn-toolbar flex-wrap gap-2"></div>
    <button id="selectAllBtn" class="btn btn-sm btn-outline-secondary">All</button>
  </div>
</div>



        <div class="chart-container">
          <canvas id="barChartProfile"style="width: 100%; height: 400px; max-width: 1200px;"></canvas>
        </div>

      <h6 class="fw-semibold mb-3 text-center" style="font-size: 1.1rem; color: #495057;">Score Breakdown by Category</h6>

        <div class="table-responsive">
          <table class="table table-bordered table-sm score-table">
            <thead class="table-light">
              <tr>
                <th>Topic</th>
                <th>Your Score</th>
                <th>Group Avg</th>
                <th>Diff</th>
              </tr>
            </thead>
            <tbody id="profileScoreTable"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>

<script>
  const preData = {{ pre_data | tojson | safe }};               // category → avg(pre,post) for ALL debates
  const groupAvg = {{ group_average | tojson | safe }};         // category → group avg
  const perDebateAvg = {{ per_debate_avg | tojson | safe }};    // debate → {category: avg(pre,post)}
  const ALL_CATEGORIES = {{ all_categories | tojson | safe }};
  const ALL_DEBATES = {{ all_debates | tojson | safe }};
</script>

<script>


  function renderProfileCharts() {
    const labels = Object.keys(preData);
    const userScores = Object.values(preData);
    const groupScores = labels.map(topic => groupAvg[topic] || 0);

    // Radar Chart
    new Chart(document.getElementById("radarChartProfile"), {
      type: "radar",
      data: {
        labels: labels,
        datasets: [
          {
            label: "You",
            data: userScores,
            backgroundColor: "rgba(66, 133, 244, 0.3)",
            borderColor: "#4285F4",
            pointBackgroundColor: "#4285F4"
          },
          {
            label: "Group Avg",
            data: groupScores,
            backgroundColor: "rgba(128, 128, 128, 0.2)",
            borderColor: "#666",
            pointBackgroundColor: "#666"
          }
        ]
      },
      options: {
        responsive: true,
        scales: {
          r: {
            min: 1,
            max: 5,
            ticks: { stepSize: 1 },
            pointLabels: { font: { size: 13 } }
          }
        },
        plugins: {
          legend: {
            position: "bottom"
          }
        }
      }
    });

    // Bar Chart
    const deviationData = userScores.map(score => score - 3);
    const colors = deviationData.map(v =>
      v > 0 ? 'rgba(219, 68, 55, 0.6)' :
      v < 0 ? 'rgba(66, 133, 244, 0.6)' :
              'rgba(180, 180, 180, 0.6)'
    );

// Register annotation plugin if available (safe no-op if already registered)
if (window['chartjs-plugin-annotation']) {
  try { Chart.register(window['chartjs-plugin-annotation']); } catch {}
}
// --- helpers ---
const avg = arr => arr.length ? arr.reduce((a,b)=>a+b,0) / arr.length : NaN;
const ALL_OPTION = "__ALL__";
const ALL_LABEL  = "All debates (Total)";

// average of a single category across all debates
function meanCategoryAcrossDebates(category) {
  const vals = (ALL_DEBATES || [])
    .map(d => perDebateAvg?.[d]?.[category])
    .filter(v => typeof v === 'number');
  return avg(vals);
}

// average (per debate) of the selected categories
function perDebateSelectedAvg(debate, categories) {
  const vals = categories
    .map(cat => perDebateAvg?.[debate]?.[cat])
    .filter(v => typeof v === 'number');
  return avg(vals);
}

// ----- Debate picker (dropdown) -----
(function ensureDebatePicker() {
  const wrap = document.getElementById('debatePickerWrap');
  if (!wrap) return;
  wrap.innerHTML = '';

  const label = document.createElement('label');
  label.className = 'form-label fw-semibold mb-0';
  label.textContent = 'Debate:';
  label.setAttribute('for', 'debatePicker');

  const select = document.createElement('select');
  select.id = 'debatePicker';
  select.className = 'form-select form-select-sm';
  select.style.width = 'auto';

  // Add ALL option first
  const optAll = document.createElement('option');
  optAll.value = ALL_OPTION;
  optAll.textContent = ALL_LABEL;
  select.appendChild(optAll);

  // Then each debate
  (ALL_DEBATES || []).forEach(d => {
    const opt = document.createElement('option');
    opt.value = d;
    opt.textContent = d;
    select.appendChild(opt);
  });

  // default to ALL
  select.value = ALL_OPTION;

  select.addEventListener('change', renderFilteredBar);

  wrap.appendChild(label);
  wrap.appendChild(select);
})();

// ----- Topic toggles (unchanged) -----
(function buildTopicToggles(){
  const topicsAll = (ALL_CATEGORIES || Object.keys(preData) || []);
  const boxWrap = document.getElementById('topicToggleControls');
  if (!boxWrap) return;
  boxWrap.innerHTML = '';

  topicsAll.forEach((t, i) => {
    const id = `topicToggle_${i}`;
    const input = document.createElement('input');
    input.type = 'checkbox';
    input.className = 'btn-check';
    input.id = id;
    input.autocomplete = 'off';
    input.value = t;
    input.checked = true;
    input.addEventListener('change', renderFilteredBar);

    const label = document.createElement('label');
    label.className = 'btn btn-sm btn-outline-secondary topic-chip';
    label.setAttribute('for', id);
    label.textContent = t;

    boxWrap.appendChild(input);
    boxWrap.appendChild(label);
  });

  const allBtn = document.getElementById('selectAllBtn');
  if (allBtn) {
    allBtn.addEventListener('click', () => {
      boxWrap.querySelectorAll('input.btn-check').forEach(cb => { cb.checked = true; });
      renderFilteredBar();
    });
  }
})();

let barProfileChart;

function renderFilteredBar() {
  const chartEl = document.getElementById("barChartProfile");
  if (!chartEl) return;

  const debatePicker = document.getElementById('debatePicker');
  const selectedDebate = debatePicker ? debatePicker.value : ALL_OPTION;

  // which topics are ON?
  let checked = Array.from(document.querySelectorAll('#topicToggleControls input.btn-check'))
    .filter(cb => cb.checked)
    .map(cb => cb.value);

  if (!checked.length) checked = (ALL_CATEGORIES || Object.keys(preData) || []);

  // labels = selected topics + "Total"
  const labelsB = [...checked, 'Total'];

  // per-topic scores depend on selection
  const perTopicScores = checked.map(cat => {
    if (selectedDebate === ALL_OPTION) {
      return meanCategoryAcrossDebates(cat);           // avg across all debates
    }
    const s = perDebateAvg?.[selectedDebate]?.[cat];   // this debate only
    return (typeof s === 'number') ? s : NaN;
  });

  const selectedDeviations = perTopicScores.map(s => (typeof s === 'number' ? s - 3 : NaN));

  // "Total" = avg over debates of (avg over selected categories)  — unchanged logic
  const perDebateAverages = (ALL_DEBATES || [])
    .map(d => perDebateSelectedAvg(d, checked))
    .filter(v => !Number.isNaN(v));

  const overallAvgAcrossDebates = avg(perDebateAverages);
  const totalDeviation = (typeof overallAvgAcrossDebates === 'number' && !Number.isNaN(overallAvgAcrossDebates))
    ? (overallAvgAcrossDebates - 3)
    : NaN;

  const dataB = [...selectedDeviations, totalDeviation];

  const colorsB = dataB.map(v =>
    (v || v === 0) && !Number.isNaN(v)
      ? (v > 0 ? 'rgba(219, 68, 55, 0.6)'
               : v < 0 ? 'rgba(66, 133, 244, 0.6)'
                       : 'rgba(180, 180, 180, 0.6)')
      : 'rgba(200, 200, 200, 0.3)'
  );

  const options = {
    indexAxis: 'y',
    scales: {
      x: {
        min: -2, max: 2,
        ticks: {
          stepSize: 1,
          callback: (value) => {
            switch (value) {
              case -2: return "1 (Liberal)";
              case -1: return "2";
              case  0: return "3 (Neutral)";
              case  1: return "4";
              case  2: return "5 (Conservative)";
              default: return "";
            }
          }
        }
      }
    },
    plugins: {
      legend: { display: false },
      annotation: {
        annotations: {
          centerLine: {
            type: 'line',
            xMin: 0,
            xMax: 0,
            borderColor: '#333',
            borderWidth: 2,
            borderDash: [4, 4],
          }
        }
      },
      tooltip: {
        callbacks: {
          label: (ctx) => {
            const isTotal = ctx.label === 'Total';
            if (isTotal) {
              const avgScore = (ctx.raw + 3);
              return `Overall Avg (All Debates): ${Number.isNaN(avgScore) ? 'N/A' : avgScore.toFixed(2)}`;
            }
            const topic = ctx.label;
            const s = (selectedDebate === ALL_OPTION)
              ? meanCategoryAcrossDebates(topic)
              : perDebateAvg?.[selectedDebate]?.[topic];

            if (typeof s !== 'number') return 'No data';
            const prefix = (selectedDebate === ALL_OPTION) ? 'All Debates' : selectedDebate;
            return `Score (${prefix}): ${s.toFixed(2)} (dev ${(s-3).toFixed(2)})`;
          }
        }
      }
    }
  };

  if (!barProfileChart) {
    barProfileChart = new Chart(chartEl, {
      type: 'bar',
      data: {
        labels: labelsB,
        datasets: [{
          label: 'Political Alignment (avg PRE+POST)',
          data: dataB,
          backgroundColor: colorsB
        }]
      },
      options
    });
  } else {
    barProfileChart.data.labels = labelsB;
    barProfileChart.data.datasets[0].data = dataB;
    barProfileChart.data.datasets[0].backgroundColor = colorsB;
    barProfileChart.options = options;
    barProfileChart.update();
  }
}

// initial draw
renderFilteredBar();


    // Table
    const tbody = document.getElementById("profileScoreTable");
    labels.forEach((topic, i) => {
      const userPercent = ((userScores[i] - 1) / 4 * 100).toFixed(0);
      const groupPercent = ((groupScores[i] - 1) / 4 * 100).toFixed(0);
      const diff = userPercent - groupPercent;
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${topic}</td>
        <td class="fw-bold">${userPercent}%</td>
        <td>${groupPercent}%</td>
        <td class="${diff > 0 ? 'text-success' : diff < 0 ? 'text-danger' : ''}">
          ${diff > 0 ? '+' : ''}${diff}%
        </td>`;
      tbody.appendChild(row);
    });
  }

  document.addEventListener("DOMContentLoaded", renderProfileCharts);
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]');
    [...popoverTriggerList].forEach(el => new bootstrap.Popover(el));
  });
</script>
</body>
</html>
